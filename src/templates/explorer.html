<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Datos ⚽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        /* Collapsed Sidebar */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .nav-link {
            color: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }

        .nav-link i {
            width: 25px;
        }

        /* Excel-like Table Styles */
        .excel-table {
            background: #fff;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            width: 100%;
        }

        .excel-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 8px;
            vertical-align: middle;
            font-weight: 600;
            color: #495057;
            text-align: center;
        }

        .excel-table td {
            padding: 6px 8px;
            vertical-align: middle;
            border: 1px solid #dee2e6;
        }

        .excel-table tbody tr:hover {
            background-color: #e8f0fe;
        }

        /* Filter Inputs in Header */
        .header-filter {
            width: 100%;
            padding: 4px;
            font-size: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* Specific Column Styles */
        .col-ah {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
            background-color: #e8f5e9;
        }

        .col-res {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
        }

        .col-team {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .col-prev {
            font-size: 0.85rem;
        }

        .bg-win {
            background-color: #d1e7dd;
        }

        .bg-loss {
            background-color: #f8d7da;
        }

        .bg-draw {
            background-color: #fff3cd;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
                padding-top: 60px;
                /* Space for mobile header */
            }

            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 50px;
                background: #fff;
                z-index: 999;
                padding: 0 15px;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Table optimizations for mobile */
            .excel-table {
                font-size: 0.75rem;
            }

            .excel-table th,
            .excel-table td {
                padding: 4px;
            }

            .header-filter {
                font-size: 0.7rem;
                padding: 2px;
            }

            .col-ah,
            .col-res {
                width: 50px;
                font-size: 0.85rem;
            }

            .col-team {
                font-size: 0.8rem;
                min-width: 100px;
            }

            .col-prev {
                min-width: 110px;
            }
        }

        .mobile-header {
            display: none;
        }

        /* H2H Col3 - Fondo rosa para distinguirla */
        .col-h2h-col3 {
            background-color: #ffe4ec !important;
        }

        /* Fondo rojo claro para celdas sin datos */
        .cell-no-data {
            background-color: #ffcdd2 !important;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <!-- Mobile Header & Overlay -->
    <div class="mobile-header">
        <button class="btn btn-link text-dark p-0 me-3" id="mobile-menu-toggle">
            <i class="fa-solid fa-bars fa-lg"></i>
        </button>
        <h5 class="mb-0">Explorador</h5>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4 text-primary"><i class="fa-solid fa-futbol me-2"></i>Analizador</h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/estudio"><i class="fa-solid fa-chart-line"></i> Estudio</a>
            <a class="nav-link active" href="/explorador"><i class="fa-solid fa-compass"></i> Explorador</a>
            <a class="nav-link" href="/precacheo"><i class="fa-solid fa-clock"></i> Pre-Cacheo</a>
            <a class="nav-link" href="/todos_resultados"><i class="fa-solid fa-list"></i> Resultados</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-secondary btn-sm" id="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <h4 class="mb-0"><i class="fa-solid fa-table me-2"></i>Explorador de Datos</h4>
            </div>
            <div class="d-flex gap-2">
                <div class="form-check d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="filter-only-with-history">
                    <label class="form-check-label small" for="filter-only-with-history">Solo con historial</label>
                </div>
                <div class="form-check d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="filter-exclude-empty">
                    <label class="form-check-label small" for="filter-exclude-empty">Ocultar vacíos</label>
                </div>
                <button class="btn btn-primary btn-sm" onclick="triggerSearch()"><i class="fa-solid fa-filter me-1"></i>
                    Aplicar Filtros</button>
            </div>
        </div>

        <!-- Pending Results Section -->
        <div class="mb-3">
            <div class="d-flex align-items-center mb-2 gap-3">
                <button class="btn btn-warning btn-sm" type="button" data-bs-toggle="collapse"
                    data-bs-target="#pendingMatchesCollapse" aria-expanded="false"
                    aria-controls="pendingMatchesCollapse" onclick="loadPendingMatches()">
                    <i class="fa-solid fa-clock-rotate-left me-1"></i> Ver Partidos Pendientes (??)
                </button>
            </div>

            <div class="collapse" id="pendingMatchesCollapse">
                <div class="card card-body bg-light">
                    <h6 class="card-title">Partidos sin resultado final</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered bg-white" id="pending-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Local</th>
                                    <th>Visitante</th>
                                    <th>Marcador</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="pending-table-body">
                                <tr>
                                    <td colspan="5" class="text-center">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pagination Controls Above Table -->
        <div class="d-flex justify-content-between align-items-center mb-2 px-2 py-2 bg-light rounded"
            id="pagination-bar" style="display: none !important;">
            <span class="text-muted small" id="pagination-info">Mostrando 0 de 0</span>
            <nav aria-label="Page navigation" id="pagination-nav-top" class="d-none">
                <ul class="pagination pagination-sm mb-0" id="pagination-lista-top">
                    <!-- Javascript populates this -->
                </ul>
            </nav>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-sm excel-table" id="results-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Fecha</th>
                        <th>Local</th>
                        <th>Visitante</th>
                        <th style="width: 80px;">
                            HA
                            <select class="header-filter" id="filter-handicap">
                                <option value="">Todos</option>
                                <option value="0.0">0.0</option>
                                <option value="0.25">0.25</option>
                                <option value="0.5">0.5</option>
                                <option value="0.75">0.75</option>
                                <option value="1.0">1.0</option>
                                <option value="1.25">1.25</option>
                                <option value="1.5">1.5</option>
                                <option value="1.75">1.75</option>
                                <option value="2.0">2.0</option>
                                <option value="2.25">2.25</option>
                                <option value="2.5">2.5+</option>
                                <option value="-0.25">-0.25</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-0.75">-0.75</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.25">-1.25</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-1.75">-1.75</option>
                                <option value="-2.0">-2.0</option>
                                <option value="-2.25">-2.25</option>
                                <option value="-2.5">-2.5+</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-ou" style="width: 100%;">
                                <option value="">O/U</option>
                                <option value="2.0">2.0</option>
                                <option value="2.5">2.5</option>
                                <option value="3.0">3.0</option>
                                <option value="3.5">3.5</option>
                                <option value="4.0">4+</option>
                            </select>
                        </th>
                        <th style="width: 80px;">
                            FT
                            <select class="header-filter mt-1" id="filter-cover-result" style="width: 100%;">
                                <option value="">Cover...</option>
                                <option value="COVER">Fav. Cubrió</option>
                                <option value="PUSH">Push</option>
                                <option value="NO_COVER">Fav. NO Cubrió</option>
                            </select>
                        </th>
                        <th>
                            Prev Home
                            <select class="header-filter mt-1" id="filter-prev-home-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.25">0.25</option>
                                <option value="0.5">0.5</option>
                                <option value="0.75">0.75</option>
                                <option value="1.0">1.0</option>
                                <option value="1.25">1.25</option>
                                <option value="1.5">1.5</option>
                                <option value="1.75">1.75</option>
                                <option value="2.0">2.0</option>
                                <option value="2.25">2.25</option>
                                <option value="2.5">2.5+</option>
                                <option value="-0.25">-0.25</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-0.75">-0.75</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.25">-1.25</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-1.75">-1.75</option>
                                <option value="-2.0">-2.0</option>
                                <option value="-2.25">-2.25</option>
                                <option value="-2.5">-2.5+</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-home-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th>
                            Prev Away
                            <select class="header-filter mt-1" id="filter-prev-away-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.25">0.25</option>
                                <option value="0.5">0.5</option>
                                <option value="0.75">0.75</option>
                                <option value="1.0">1.0</option>
                                <option value="1.25">1.25</option>
                                <option value="1.5">1.5</option>
                                <option value="1.75">1.75</option>
                                <option value="2.0">2.0</option>
                                <option value="2.25">2.25</option>
                                <option value="2.5">2.5+</option>
                                <option value="-0.25">-0.25</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-0.75">-0.75</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.25">-1.25</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-1.75">-1.75</option>
                                <option value="-2.0">-2.0</option>
                                <option value="-2.25">-2.25</option>
                                <option value="-2.5">-2.5+</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-away-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th style="width: 100px;">H2H Estadio</th>
                        <th style="width: 100px;">H2H General</th>
                        <th>H2H Col3</th>
                        <th>Ind. Local</th>
                        <th>Ind. Visitante</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="loading-overlay" class="d-none">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>

    <script>
        // Pagination State
        let currentPage = 1;
        const itemsPerPage = 500;
        let totalResults = [];

        function triggerSearch() {
            const filters = {
                handicap: document.getElementById('filter-handicap').value || null,
                team: null, // Team search inputs removed
                prev_home_wdl: document.getElementById('filter-prev-home-res').value || null,
                prev_away_wdl: document.getElementById('filter-prev-away-res').value || null,
                prev_home_ah: document.getElementById('filter-prev-home-ah').value || null,
                prev_away_ah: document.getElementById('filter-prev-away-ah').value || null,
                exclude_empty: document.getElementById('filter-exclude-empty').checked,
                only_with_history: document.getElementById('filter-only-with-history').checked,
                limit: 2000 // Fetch large amount to allow client-side pagination up to user needs
            };

            const spinner = document.getElementById('loading-overlay');
            spinner.classList.remove('d-none');

            fetch('/api/explorer_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filters: filters
                })
            })
                .then(response => response.json())
                .then(data => {
                    spinner.classList.add('d-none');
                    // Store results and render first page
                    totalResults = data.results || [];
                    currentPage = 1;
                    renderTableWithPagination();
                })
                .catch(err => {
                    spinner.classList.add('d-none');
                    alert('Error al cargar datos: ' + err.message);
                });
        }

        function renderTableWithPagination() {
            // Aplicar filtro client-side "Solo con historial"
            const onlyWithHistory = document.getElementById('filter-only-with-history').checked;
            let filteredResults = totalResults;

            if (onlyWithHistory) {
                filteredResults = totalResults.filter(item => {
                    // Requiere datos en AMBOS Prev Home y Prev Away
                    const hasPrevHome = item.prev_home && item.prev_home.score;
                    const hasPrevAway = item.prev_away && item.prev_away.score;
                    return hasPrevHome && hasPrevAway;
                });
            }

            // Filtro de cobertura AH (client-side)
            const coverFilter = document.getElementById('filter-cover-result').value;
            if (coverFilter) {
                filteredResults = filteredResults.filter(item => {
                    const c = item.candidate;
                    if (!c.score || c.ah_real === null || c.ah_real === undefined) return false;

                    // Determinar favorito según el signo del AH
                    // AH > 0: Favorito es LOCAL
                    // AH <= 0: Favorito es VISITANTE
                    const ah = parseFloat(c.ah_real);
                    const favoritoEsLocal = ah > 0;

                    // Parsear resultado
                    const parts = c.score.split(':');
                    if (parts.length !== 2) return false;
                    const golesLocal = parseInt(parts[0]);
                    const golesVisitante = parseInt(parts[1]);

                    // Calcular diferencia de goles
                    const diferenciaGoles = golesLocal - golesVisitante;

                    // Determinar resultado desde perspectiva del FAVORITO
                    let resultadoFavorito; // 'COVER', 'PUSH', 'NO_COVER'

                    if (favoritoEsLocal) {
                        // Favorito es LOCAL. Local da 'ah' goles de ventaja.
                        // Local cubre si: diferenciaGoles > ah
                        // Push si: diferenciaGoles === ah (solo posible con AH enteros)
                        // No cubre si: diferenciaGoles < ah
                        if (diferenciaGoles > ah) {
                            resultadoFavorito = 'COVER';
                        } else if (diferenciaGoles === ah) {
                            resultadoFavorito = 'PUSH';
                        } else {
                            resultadoFavorito = 'NO_COVER';
                        }
                    } else {
                        // Favorito es VISITANTE. Visitante da 'abs(ah)' goles de ventaja.
                        // Visitante cubre si: golesVisitante - golesLocal > abs(ah)
                        // Push si: golesVisitante - golesLocal === abs(ah)
                        // No cubre si: golesVisitante - golesLocal < abs(ah)
                        const ventajaVisitante = golesVisitante - golesLocal;
                        const lineaAbs = Math.abs(ah);

                        if (ventajaVisitante > lineaAbs) {
                            resultadoFavorito = 'COVER';
                        } else if (ventajaVisitante === lineaAbs) {
                            resultadoFavorito = 'PUSH';
                        } else {
                            resultadoFavorito = 'NO_COVER';
                        }
                    }

                    return resultadoFavorito === coverFilter;
                });
            }

            // Filtro O/U (client-side)
            const ouFilter = document.getElementById('filter-ou').value;
            if (ouFilter) {
                const filterOU = parseFloat(ouFilter);
                filteredResults = filteredResults.filter(item => {
                    const ouLine = parseFloat(item.candidate.ou_line);
                    if (isNaN(ouLine)) return false;

                    // Si el filtro es 4.0, coger 4 o superior
                    if (filterOU >= 4.0) {
                        return ouLine >= 4.0;
                    } else {
                        // Para otros valores, fuzzy match (+/- 0.26)
                        return Math.abs(ouLine - filterOU) <= 0.26;
                    }
                });
            }

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = filteredResults.slice(start, end);
            renderTable(pageItems);
            renderPaginationControls(filteredResults.length);
        }

        function applyClientFilters() {
            currentPage = 1;
            renderTableWithPagination();
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalResults.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTableWithPagination();
        }

        function renderPaginationControls(totalCount) {
            if (totalCount === undefined) totalCount = totalResults.length;
            const paginationBar = document.getElementById('pagination-bar');
            const paginationInfo = document.getElementById('pagination-info');
            const navTop = document.getElementById('pagination-nav-top');
            const listaTop = document.getElementById('pagination-lista-top');
            const totalPages = Math.ceil(totalCount / itemsPerPage);

            // Siempre mostrar la barra si hay resultados
            if (totalCount > 0) {
                if (paginationBar) paginationBar.style.cssText = 'display: flex !important;';
                const start = (currentPage - 1) * itemsPerPage + 1;
                const end = Math.min(currentPage * itemsPerPage, totalCount);
                if (paginationInfo) paginationInfo.textContent = `Mostrando ${start}-${end} de ${totalCount}`;
            } else {
                if (paginationBar) paginationBar.style.cssText = 'display: none !important;';
            }

            if (totalPages <= 1) {
                if (navTop) navTop.classList.add('d-none');
                return;
            }

            if (navTop) navTop.classList.remove('d-none');

            listaTop.innerHTML = '';

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Anterior</a>`;
            listaTop.appendChild(prevLi);

            // Info
            const infoLi = document.createElement('li');
            infoLi.className = 'page-item disabled';
            infoLi.innerHTML = `<span class="page-link">Pág ${currentPage}/${totalPages}</span>`;
            listaTop.appendChild(infoLi);

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Siguiente</a>`;
            listaTop.appendChild(nextLi);
        }

        function renderTable(results) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!results || results.length === 0) {
                tbody.innerHTML = `<tr>
        <td colspan="10" class="text-center py-4">No se encontraron resultados</td>
    </tr>`;
                return;
            }

            const formatAh = (val) => val !== null && val !== undefined ? val : '-';

            // Helper igual a Pre-Cacheo
            const isValidValue = (val) => val !== undefined && val !== null && val !== 'undefined' && val !== '';

            results.forEach(item => {
                const c = item.candidate;
                const tr = document.createElement('tr');

                // Prev Home Cell Logic
                let prevHomeHtml = '';
                let prevHomeHasData = false;
                if (item.prev_home) {
                    // Check if meaningful data exists
                    if (isValidValue(item.prev_home.score) || isValidValue(item.prev_home.ah)) {
                        prevHomeHasData = true;
                        const wdlClass = item.prev_home.wdl === 'HOME_WIN' ? 'text-success' : (item.prev_home.wdl === 'AWAY_WIN' ? 'text-danger' : (item.prev_home.wdl === 'DRAW' ? 'text-warning' : (item.prev_home.wdl === 'W' ? 'text-success' : (item.prev_home.wdl === 'L' ? 'text-danger' : 'text-warning'))));

                        prevHomeHtml = `
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${formatAh(item.prev_home.ah)}</span>
                                <span class="${wdlClass} fw-bold">${item.prev_home.score}</span>
                            </div>
                            <div class="text-muted text-truncate small" style="font-size: 0.7rem; max-width: 100px;" title="${item.prev_home.rival}">${item.prev_home.rival || '-'}</div>
                        </div>`;
                    }
                }

                // Prev Away Cell Logic
                let prevAwayHtml = '';
                let prevAwayHasData = false;
                if (item.prev_away) {
                    if (isValidValue(item.prev_away.score) || isValidValue(item.prev_away.ah)) {
                        prevAwayHasData = true;
                        const wdlClass = item.prev_away.wdl === 'HOME_WIN' ? 'text-success' : (item.prev_away.wdl === 'AWAY_WIN' ? 'text-danger' : (item.prev_away.wdl === 'DRAW' ? 'text-warning' : (item.prev_away.wdl === 'W' ? 'text-success' : (item.prev_away.wdl === 'L' ? 'text-danger' : 'text-warning'))));

                        prevAwayHtml = `
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${formatAh(item.prev_away.ah)}</span>
                                <span class="${wdlClass} fw-bold">${item.prev_away.score}</span>
                            </div>
                            <div class="text-muted text-truncate small" style="font-size: 0.7rem; max-width: 100px;" title="${item.prev_away.rival}">${item.prev_away.rival || '-'}</div>
                        </div>`;
                    }
                }

                // H2H Col3 Cell Logic
                let h2hHtml = '';
                // H2H Col3 siempre es rosa, pero verificamos contenido
                if (item.h2h_col3) {
                    const h = item.h2h_col3;
                    const handicap = isValidValue(h.ah) ? h.ah : null;
                    const score = isValidValue(h.score) ? h.score : null;

                    if (handicap || score) {
                        const homeT = h.home_team || 'Local';
                        const awayT = h.away_team || 'Visitante';
                        h2hHtml = `
                        <div class="d-flex justify-content-between">
                            <span class="fw-bold small">${formatAh(h.ah)}</span>
                            <span class="fw-bold">${h.score}</span>
                        </div>
                        <div class="small text-muted" style="font-size: 0.75rem;">${homeT} vs ${awayT}</div>
                        `;
                    }
                }

                // Ind. Local Logic
                let indLocalHtml = '';
                let indLocalHasData = false;
                if (item.ind_local) {
                    const l = item.ind_local;
                    const ahLine = isValidValue(l.ah_line) ? l.ah_line : (isValidValue(l.ah) ? l.ah : null);
                    const score = isValidValue(l.score) ? l.score : null;

                    if (ahLine || score) {
                        indLocalHasData = true;
                        indLocalHtml = `
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold small">${ahLine || '-'}</span>
                                    <span class="fw-bold">${score || '-'}</span>
                                </div>
                                ${(l.home_team || l.away_team) ? `<div class="small text-muted" style="font-size: 0.7rem;">${l.home_team || ''} vs ${l.away_team || ''}</div>` : ''}
                                ${l.localia ? `<div class="small text-muted" style="font-size: 0.65rem;">Loc: ${l.localia}</div>` : ''}
                            </div>
                        `;
                    }
                }

                // Ind. Visitante Logic
                let indVisitanteHtml = '';
                let indVisitanteHasData = false;
                if (item.ind_visitante) {
                    const r = item.ind_visitante;
                    const ahLine = isValidValue(r.ah_line) ? r.ah_line : (isValidValue(r.ah) ? r.ah : null);
                    const score = isValidValue(r.score) ? r.score : null;

                    if (ahLine || score) {
                        indVisitanteHasData = true;
                        indVisitanteHtml = `
                            <div class="d-flex flex-column">
                                <div class="d-flex justify-content-between">
                                    <span class="fw-bold small">${ahLine || '-'}</span>
                                    <span class="fw-bold">${score || '-'}</span>
                                </div>
                                ${(r.home_team || r.away_team) ? `<div class="small text-muted" style="font-size: 0.7rem;">${r.home_team || ''} vs ${r.away_team || ''}</div>` : ''}
                                ${r.localia ? `<div class="small text-muted" style="font-size: 0.65rem;">Loc: ${r.localia}</div>` : ''}
                            </div>
                        `;
                    }
                }

                tr.innerHTML = `
    <td class="text-center text-muted small">
        <a href="/estudio/${item.match_id}" target="_blank" class="text-decoration-none text-muted"
            title="Abrir en Estudio">
            ${c.date}
        </a>
    </td>
    <td class="col-team text-primary small" style="font-size: 0.8rem;">${c.home}</td>
    <td class="col-team text-danger small" style="font-size: 0.8rem;">${c.away}</td>
    <td class="col-ah">
        ${formatAh(c.ah_real)}
        ${c.ou_line ? `<div style="font-size: 0.6rem; color: #888; margin-top: -2px;">${c.ou_line}</div>` : ''}
    </td>
    <td class="col-res bg-light">${c.score}</td>
    
    <!-- Prev Home -->
    <td class="col-prev ${!prevHomeHasData ? 'cell-no-data' : ''}">${prevHomeHtml}</td>

    <!-- Prev Away -->
    <td class="col-prev ${!prevAwayHasData ? 'cell-no-data' : ''}">${prevAwayHtml}</td>
    
    <!-- H2H Estadio -->
    <td class="col-prev text-center">
        ${item.h2h_stadium ? `
            <div class="d-flex flex-column">
                <div class="fw-bold small ${item.h2h_stadium.mov_direction === 'UP' ? 'text-success' : (item.h2h_stadium.mov_direction === 'DOWN' ? 'text-danger' : 'text-dark')}">${item.h2h_stadium.movement || '-'}</div>
                ${item.h2h_stadium.score ? `<div class="small ${item.h2h_stadium.wdl === 'HOME_WIN' ? 'text-success' : (item.h2h_stadium.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark')}" style="font-size: 0.7rem;">${item.h2h_stadium.score}</div>` : ''}
            </div>
        ` : '<span class="text-muted">-</span>'}
    </td>
    <!-- H2H General -->
    <td class="col-prev text-center">
        ${item.h2h_general ? `
            <div class="d-flex flex-column">
                <div class="fw-bold small ${item.h2h_general.mov_direction === 'UP' ? 'text-success' : (item.h2h_general.mov_direction === 'DOWN' ? 'text-danger' : 'text-dark')}">${item.h2h_general.movement || '-'}</div>
                ${item.h2h_general.score ? `<div class="small ${item.h2h_general.wdl === 'HOME_WIN' ? 'text-success' : (item.h2h_general.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark')}" style="font-size: 0.7rem;">${item.h2h_general.score}</div>` : ''}
            </div>
        ` : '<span class="text-muted">-</span>'}
    </td>

    <!-- H2H Col3 (Always Pink) -->
    <td class="col-prev col-h2h-col3 text-center">${h2hHtml}</td>
    
    <!-- Ind. Local -->
    <td class="col-prev ${!indLocalHasData ? 'cell-no-data' : ''}">${indLocalHtml}</td>
    
    <!-- Ind. Visitante -->
    <td class="col-prev ${!indVisitanteHasData ? 'cell-no-data' : ''}">${indVisitanteHtml}</td>
    `;
                tbody.appendChild(tr);
            });
        }

        // Sidebar Toggle Logic
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-active');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }

        // Enter key on inputs triggers search
        document.querySelectorAll('.header-filter').forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    triggerSearch();
                }
            });
            // Removed: automatic triggerSearch on SELECT change
        });
        // Mobile Menu Logic
        document.addEventListener('DOMContentLoaded', () => {
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebar = document.querySelector('.sidebar');

            if (mobileToggle) {
                mobileToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    const icon = mobileToggle.querySelector('i');
                    if (sidebar.classList.contains('active')) {
                        icon.classList.replace('fa-bars', 'fa-xmark');
                    } else {
                        icon.classList.replace('fa-xmark', 'fa-bars');
                    }
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    mobileToggle.querySelector('i').classList.replace('fa-xmark', 'fa-bars');
                });
            }
        });
        // Match re-analysis logic is handled via API
        function loadPendingMatches() {
            const tbody = document.getElementById('pending-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Cargando...</td></tr>';

            fetch('/api/pending_matches')
                .then(res => res.json())
                .then(data => {
                    renderPendingTable(data.matches || []);
                })
                .catch(err => {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Error: ${err.message}</td></tr>`;
                });
        }

        function renderPendingTable(matches) {
            const tbody = document.getElementById('pending-table-body');
            if (matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay partidos pendientes.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            matches.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.match_date || m.date || '-'}</td>
                    <td>${m.home_team || m.home_name}</td>
                    <td>${m.away_team || m.away_name}</td>
                    <td class="fw-bold text-center">${m.score || m.final_score || '??'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="reanalyzeMatch('${m.match_id}', this)">
                            <i class="fa-solid fa-rotate"></i> Re-scan
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function reanalyzeMatch(matchId, btn) {
            if (!confirm('¿Re-analizar este partido para buscar resultado final?')) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            fetch('/api/reanalyze_pending', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ match_id: matchId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                    } else {
                        if (data.result_found) {
                            alert(`¡Actualizado! Nuevo resultado: ${data.match.score}`);
                            // Reload list
                            loadPendingMatches();
                        } else {
                            alert('Aún no hay resultado final disponible.');
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                        }
                    }
                })
                .catch(err => {
                    alert('Error de red: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                });
        }
    </script>
</body>

</html>