<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explorador de Datos ⚽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .nav-link {
            color: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }

        .nav-link i {
            width: 25px;
        }

        /* Excel-like Table Styles */
        .excel-table {
            background: #fff;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            width: 100%;
        }

        .excel-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 8px;
            vertical-align: middle;
            font-weight: 600;
            color: #495057;
            text-align: center;
        }

        .excel-table td {
            padding: 6px 8px;
            vertical-align: middle;
            border: 1px solid #dee2e6;
        }

        .excel-table tbody tr:hover {
            background-color: #e8f0fe;
        }

        /* Filter Inputs in Header */
        .header-filter {
            width: 100%;
            padding: 4px;
            font-size: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* Specific Column Styles */
        .col-ah {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
            background-color: #e8f5e9;
        }

        .col-res {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
        }

        .col-team {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .col-prev {
            font-size: 0.85rem;
        }

        .bg-win {
            background-color: #d1e7dd;
        }

        .bg-loss {
            background-color: #f8d7da;
        }

        .bg-draw {
            background-color: #fff3cd;
        }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease-in-out;
                width: 280px;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
                padding-top: 60px;
                /* Space for mobile header */
            }

            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 50px;
                background: #fff;
                z-index: 999;
                padding: 0 15px;
                align-items: center;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 999;
            }

            .sidebar-overlay.active {
                display: block;
            }

            /* Table optimizations for mobile */
            .excel-table {
                font-size: 0.75rem;
            }

            .excel-table th,
            .excel-table td {
                padding: 4px;
            }

            .header-filter {
                font-size: 0.7rem;
                padding: 2px;
            }

            .col-ah,
            .col-res {
                width: 50px;
                font-size: 0.85rem;
            }

            .col-team {
                font-size: 0.8rem;
                min-width: 100px;
            }

            .col-prev {
                min-width: 110px;
            }
        }

        .mobile-header {
            display: none;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <!-- Mobile Header & Overlay -->
    <div class="mobile-header">
        <button class="btn btn-link text-dark p-0 me-3" id="mobile-menu-toggle">
            <i class="fa-solid fa-bars fa-lg"></i>
        </button>
        <h5 class="mb-0">Explorador</h5>
    </div>
    <div class="sidebar-overlay" id="sidebar-overlay"></div>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4 text-primary"><i class="fa-solid fa-futbol me-2"></i>Analizador</h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/estudio"><i class="fa-solid fa-chart-line"></i> Estudio</a>
            <a class="nav-link active" href="/explorador"><i class="fa-solid fa-compass"></i> Explorador</a>
            <a class="nav-link" href="/precacheo"><i class="fa-solid fa-clock"></i> Pre-Cacheo</a>
            <a class="nav-link" href="/todos_resultados"><i class="fa-solid fa-list"></i> Resultados</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0"><i class="fa-solid fa-table me-2"></i>Explorador de Datos</h4>
            <div class="d-flex gap-2">
                <div class="form-check d-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" id="filter-exclude-empty">
                    <label class="form-check-label small" for="filter-exclude-empty">Ocultar vacíos</label>
                </div>
                <button class="btn btn-primary btn-sm" onclick="triggerSearch()"><i class="fa-solid fa-filter me-1"></i>
                    Aplicar Filtros</button>
            </div>
        </div>

        <!-- Pending Results Section -->
        <div class="mb-3">
            <div class="d-flex align-items-center mb-2 gap-3">
                <button class="btn btn-warning btn-sm" type="button" data-bs-toggle="collapse"
                    data-bs-target="#pendingMatchesCollapse" aria-expanded="false"
                    aria-controls="pendingMatchesCollapse" onclick="loadPendingMatches()">
                    <i class="fa-solid fa-clock-rotate-left me-1"></i> Ver Partidos Pendientes (??)
                </button>

                <!-- Top Pagination Controls -->
                <nav aria-label="Page navigation" id="pagination-nav-top" class="d-none">
                    <ul class="pagination pagination-sm mb-0" id="pagination-lista-top">
                        <!-- Javascript populates this -->
                    </ul>
                </nav>
            </div>

            <div class="collapse" id="pendingMatchesCollapse">
                <div class="card card-body bg-light">
                    <h6 class="card-title">Partidos sin resultado final</h6>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-sm table-bordered bg-white" id="pending-table">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Local</th>
                                    <th>Visitante</th>
                                    <th>Marcador</th>
                                    <th>Acción</th>
                                </tr>
                            </thead>
                            <tbody id="pending-table-body">
                                <tr>
                                    <td colspan="5" class="text-center">Cargando...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-sm excel-table" id="results-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Fecha</th>
                        <th>Local</th>
                        <th>Visitante</th>
                        <th style="width: 80px;">
                            HA
                            <select class="header-filter" id="filter-handicap">
                                <option value="">Todos</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="2.5">2.5</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                                <option value="-2.5">-2.5</option>
                            </select>
                        </th>
                        <th style="width: 80px;">FT</th>
                        <th>
                            Prev Home
                            <select class="header-filter mt-1" id="filter-prev-home-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-home-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th>
                            Prev Away
                            <select class="header-filter mt-1" id="filter-prev-away-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-away-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th style="width: 100px;">H2H Estadio</th>
                        <th style="width: 100px;">H2H General</th>
                        <th>H2H Col3</th>
                        <th>Ind. Local</th>
                        <th>Ind. Visitante</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>

        <div id="loading-overlay" class="d-none">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    </div>

    <script>
        // Pagination State
        let currentPage = 1;
        const itemsPerPage = 300;
        let totalResults = [];

        function triggerSearch() {
            const filters = {
                handicap: document.getElementById('filter-handicap').value || null,
                team: null, // Team search inputs removed
                prev_home_wdl: document.getElementById('filter-prev-home-res').value || null,
                prev_away_wdl: document.getElementById('filter-prev-away-res').value || null,
                prev_home_ah: document.getElementById('filter-prev-home-ah').value || null,
                prev_away_ah: document.getElementById('filter-prev-away-ah').value || null,
                exclude_empty: document.getElementById('filter-exclude-empty').checked,
                limit: 2000 // Fetch large amount to allow client-side pagination up to user needs
            };

            const spinner = document.getElementById('loading-overlay');
            spinner.classList.remove('d-none');

            fetch('/api/explorer_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filters: filters
                })
            })
                .then(response => response.json())
                .then(data => {
                    spinner.classList.add('d-none');
                    // Store results and render first page
                    totalResults = data.results || [];
                    currentPage = 1;
                    renderTableWithPagination();
                })
                .catch(err => {
                    spinner.classList.add('d-none');
                    alert('Error al cargar datos: ' + err.message);
                });
        }

        function renderTableWithPagination() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = totalResults.slice(start, end);
            renderTable(pageItems);
            renderPaginationControls();
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalResults.length / itemsPerPage);
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            renderTableWithPagination();
        }

        function renderPaginationControls() {
            const navTop = document.getElementById('pagination-nav-top');
            const listaTop = document.getElementById('pagination-lista-top');
            const totalPages = Math.ceil(totalResults.length / itemsPerPage);

            if (totalPages <= 1) {
                if (navTop) navTop.classList.add('d-none');
                return;
            }

            if (navTop) navTop.classList.remove('d-none');

            listaTop.innerHTML = '';

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Anterior</a>`;
            listaTop.appendChild(prevLi);

            // Info
            const infoLi = document.createElement('li');
            infoLi.className = 'page-item disabled';
            infoLi.innerHTML = `<span class="page-link">Pág ${currentPage}/${totalPages} (${totalResults.length})</span>`;
            listaTop.appendChild(infoLi);

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Siguiente</a>`;
            listaTop.appendChild(nextLi);
        }

        function renderTable(results) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!results || results.length === 0) {
                tbody.innerHTML = `<tr>
        <td colspan="8" class="text-center py-4">No se encontraron resultados</td>
    </tr>`;
                return;
            }

            const formatAh = (val) => val !== null && val !== undefined ? val : '-';

            results.forEach(item => {
                const c = item.candidate;
                const tr = document.createElement('tr');

                // Prev Home Cell
                let prevHomeHtml = '<span class="text-muted">-</span>';
                if (item.prev_home) {
                    const wdlClass = item.prev_home.wdl === 'W' ? 'text-success' : (item.prev_home.wdl === 'L' ? 'text-danger' :
                        'text-warning');
                    prevHomeHtml = `
    <div class="d-flex justify-content-between">
        <span class="fw-bold small">${formatAh(item.prev_home.ah)}</span>
        <span class="${wdlClass} fw-bold">${item.prev_home.score}</span>
    </div>
    <div class="small text-muted text-truncate" style="max-width: 120px;">vs ${item.prev_home.rival}</div>
    `;
                }

                // Prev Away Cell
                let prevAwayHtml = '<span class="text-muted">-</span>';
                if (item.prev_away) {
                    const wdlClass = item.prev_away.wdl === 'W' ? 'text-success' : (item.prev_away.wdl === 'L' ? 'text-danger' :
                        'text-warning');
                    prevAwayHtml = `
    <div class="d-flex justify-content-between">
        <span class="fw-bold small">${formatAh(item.prev_away.ah)}</span>
        <span class="${wdlClass} fw-bold">${item.prev_away.score}</span>
    </div>
    <div class="small text-muted text-truncate" style="max-width: 120px;">${item.prev_away.rival} vs</div>
    `;
                }

                // H2H Col3 Cell
                let h2hHtml = '<span class="text-muted">-</span>';
                if (item.h2h_col3) {
                    const homeT = item.h2h_col3.home_team || 'Local';
                    const awayT = item.h2h_col3.away_team || 'Visitante';
                    h2hHtml = `
    <div class="d-flex justify-content-between">
        <span class="fw-bold small">${formatAh(item.h2h_col3.ah)}</span>
        <span class="fw-bold">${item.h2h_col3.score}</span>
    </div>
    <div class="small text-muted" style="font-size: 0.75rem;">${homeT} vs ${awayT}</div>
    `;
                }

                tr.innerHTML = `
    <td class="text-center text-muted small">
        <a href="/estudio/${item.match_id}" target="_blank" class="text-decoration-none text-muted"
            title="Abrir en Estudio">
            ${c.date}
        </a>
    </td>
    <td class="col-team text-primary small" style="font-size: 0.8rem;">${c.home}</td>
    <td class="col-team text-danger small" style="font-size: 0.8rem;">${c.away}</td>
    <td class="col-ah">${formatAh(c.ah_real)}</td>
    <td class="col-res bg-light">${c.score}</td>
    
    <!-- Prev Home (Merged) -->
    <td class="col-prev">
        ${item.prev_home ? `
             <div class="d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small">${formatAh(item.prev_home.ah)}</span>
                    <span class="${item.prev_home.wdl === 'HOME_WIN' ? 'text-success' : (item.prev_home.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-warning')} fw-bold">${item.prev_home.score || '?:?'}</span>
                </div>
                <div class="text-muted text-truncate small" style="font-size: 0.7rem; max-width: 100px;" title="${item.prev_home.rival}">${item.prev_home.rival || '-'}</div>
             </div>
        ` : '<span class="text-muted">-</span>'}
    </td>

    <!-- Prev Away (Merged) -->
    <td class="col-prev">
        ${item.prev_away ? `
             <div class="d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small">${formatAh(item.prev_away.ah)}</span>
                    <span class="${item.prev_away.wdl === 'HOME_WIN' ? 'text-success' : (item.prev_away.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-warning')} fw-bold">${item.prev_away.score || '?:?'}</span>
                </div>
                <div class="text-muted text-truncate small" style="font-size: 0.7rem; max-width: 100px;" title="${item.prev_away.rival}">${item.prev_away.rival || '-'}</div>
             </div>
        ` : '<span class="text-muted">-</span>'}
    </td>
    
    <!-- H2H Estadio (Movement + Score from market_analysis_html) -->
    <td class="col-prev text-center">
        ${item.h2h_stadium ? `
            <div class="d-flex flex-column">
                <div class="fw-bold small ${item.h2h_stadium.mov_direction === 'UP' ? 'text-success' : (item.h2h_stadium.mov_direction === 'DOWN' ? 'text-danger' : 'text-dark')}">${item.h2h_stadium.movement || '-'}</div>
                ${item.h2h_stadium.score ? `<div class="small ${item.h2h_stadium.wdl === 'HOME_WIN' ? 'text-success' : (item.h2h_stadium.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark')}" style="font-size: 0.7rem;">${item.h2h_stadium.score}</div>` : ''}
            </div>
        ` : '<span class="text-muted">-</span>'}
    </td>
    <!-- H2H General (Movement + Score from market_analysis_html) -->
    <td class="col-prev text-center">
        ${item.h2h_general ? `
            <div class="d-flex flex-column">
                <div class="fw-bold small ${item.h2h_general.mov_direction === 'UP' ? 'text-success' : (item.h2h_general.mov_direction === 'DOWN' ? 'text-danger' : 'text-dark')}">${item.h2h_general.movement || '-'}</div>
                ${item.h2h_general.score ? `<div class="small ${item.h2h_general.wdl === 'HOME_WIN' ? 'text-success' : (item.h2h_general.wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark')}" style="font-size: 0.7rem;">${item.h2h_general.score}</div>` : ''}
            </div>
        ` : '<span class="text-muted">-</span>'}
    </td>

    <td class="col-prev">${h2hHtml}</td>
    
    <!-- Ind. Local -->
    <td class="col-prev">
        ${item.ind_local ? `
            <div class="d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small">${item.ind_local.ah_line || item.ind_local.ah || '-'}</span>
                    <span class="fw-bold">${item.ind_local.score || '?:?'}</span>
                </div>
                <div class="small text-muted" style="font-size: 0.7rem;">${item.ind_local.home_team || ''} vs ${item.ind_local.away_team || ''}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">Loc: ${item.ind_local.localia || '?'}</div>
            </div>
        ` : '<span class="text-muted">NO</span>'}
    </td>
    
    <!-- Ind. Visitante -->
    <td class="col-prev">
        ${item.ind_visitante ? `
            <div class="d-flex flex-column">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold small">${item.ind_visitante.ah_line || item.ind_visitante.ah || '-'}</span>
                    <span class="fw-bold">${item.ind_visitante.score || '?:?'}</span>
                </div>
                <div class="small text-muted" style="font-size: 0.7rem;">${item.ind_visitante.home_team || ''} vs ${item.ind_visitante.away_team || ''}</div>
                <div class="small text-muted" style="font-size: 0.65rem;">Loc: ${item.ind_visitante.localia || '?'}</div>
            </div>
        ` : '<span class="text-muted">NO</span>'}
    </td>
    `;
                tbody.appendChild(tr);
            });
        }

        // Enter key on inputs triggers search
        document.querySelectorAll('.header-filter').forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    triggerSearch();
                }
            });
            input.addEventListener('change', function (e) {
                if (e.target.tagName === 'SELECT') {
                    triggerSearch();
                }
            });
        });
        // Mobile Menu Logic
        document.addEventListener('DOMContentLoaded', () => {
            const mobileToggle = document.getElementById('mobile-menu-toggle');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebar = document.querySelector('.sidebar');

            if (mobileToggle) {
                mobileToggle.addEventListener('click', () => {
                    sidebar.classList.toggle('active');
                    sidebarOverlay.classList.toggle('active');
                    const icon = mobileToggle.querySelector('i');
                    if (sidebar.classList.contains('active')) {
                        icon.classList.replace('fa-bars', 'fa-xmark');
                    } else {
                        icon.classList.replace('fa-xmark', 'fa-bars');
                    }
                });
            }

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    mobileToggle.querySelector('i').classList.replace('fa-xmark', 'fa-bars');
                });
            }
        });
        // Match re-analysis logic is handled via API
        function loadPendingMatches() {
            const tbody = document.getElementById('pending-table-body');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center">Cargando...</td></tr>';

            fetch('/api/pending_matches')
                .then(res => res.json())
                .then(data => {
                    renderPendingTable(data.matches || []);
                })
                .catch(err => {
                    tbody.innerHTML = `<tr><td colspan="5" class="text-danger text-center">Error: ${err.message}</td></tr>`;
                });
        }

        function renderPendingTable(matches) {
            const tbody = document.getElementById('pending-table-body');
            if (matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay partidos pendientes.</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            matches.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.match_date || m.date || '-'}</td>
                    <td>${m.home_team || m.home_name}</td>
                    <td>${m.away_team || m.away_name}</td>
                    <td class="fw-bold text-center">${m.score || m.final_score || '??'}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-primary" onclick="reanalyzeMatch('${m.match_id}', this)">
                            <i class="fa-solid fa-rotate"></i> Re-scan
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function reanalyzeMatch(matchId, btn) {
            if (!confirm('¿Re-analizar este partido para buscar resultado final?')) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            fetch('/api/reanalyze_pending', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ match_id: matchId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        alert('Error: ' + data.error);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                    } else {
                        if (data.result_found) {
                            alert(`¡Actualizado! Nuevo resultado: ${data.match.score}`);
                            // Reload list
                            loadPendingMatches();
                        } else {
                            alert('Aún no hay resultado final disponible.');
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                        }
                    }
                })
                .catch(err => {
                    alert('Error de red: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Re-scan';
                });
        }
    </script>
</body>

</html>