<div class="analysis-panel" data-current-match="{{ data.match_id or data.id }}">
    <style>
        .analysis-panel .home-color {
            color: #2563eb;
            font-weight: 700;
        }

        .analysis-panel .away-color {
            color: #f97316;
            font-weight: 700;
        }

        .analysis-panel .score-value {
            font-weight: 700;
            color: #16a34a;
        }

        .analysis-panel .ah-value {
            font-weight: 600;
            color: #6f42c1;
        }

        .analysis-panel .data-highlight {
            font-weight: 600;
            color: #dc2626;
        }

        .analysis-panel .panel-odds {
            margin-top: 0.4rem;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .analysis-panel .panel-odds .odds-chip {
            background: #eef2ff;
            color: #3730a3;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .analysis-panel .stat-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.35rem;
        }

        .analysis-panel .stat-table td {
            padding: 4px 8px;
            font-size: 0.92rem;
        }

        .analysis-panel .stat-table td.home {
            color: #2563eb;
            font-weight: 600;
            text-align: left;
        }

        .analysis-panel .stat-table td.away {
            color: #f97316;
            font-weight: 600;
            text-align: right;
        }

        .analysis-panel .stat-table td.label {
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            min-width: 120px;
        }

        .analysis-panel .market-analysis-wrapper {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            border: 1px solid #e2e8f0;
        }

        .analysis-panel .market-analysis-wrapper h3 {
            font-size: 1.05rem;
            margin-bottom: 0.75rem;
        }

        .analysis-panel .market-analysis-wrapper table {
            width: 100%;
        }

        @media (max-width: 768px) {
            .historical-matches-container table {
                font-size: 0.7rem !important;
            }

            .historical-matches-container .card-header h6 {
                font-size: 0.9rem;
            }

            .historical-matches-container .badge {
                font-size: 0.7rem;
            }

            /* Mobile optimizations for 3-col and 2-col layouts */
            .immediate-history-row .card-body,
            .indirect-comparison-row .card-body {
                padding: 0.25rem !important;
            }

            .immediate-history-row .card-title,
            .immediate-history-row .card-subtitle,
            .indirect-comparison-row .card-title,
            .indirect-comparison-row .card-subtitle {
                font-size: 0.7rem !important;
                margin-bottom: 0.25rem !important;
            }

            .immediate-history-row p,
            .indirect-comparison-row p {
                font-size: 0.65rem !important;
                margin-bottom: 0.15rem !important;
                line-height: 1.2;
            }

            .immediate-history-row .stat-table td,
            .indirect-comparison-row .stat-table td {
                font-size: 0.6rem !important;
                padding: 1px !important;
            }

            .immediate-history-row .stat-table td.label,
            .indirect-comparison-row .stat-table td.label {
                min-width: auto !important;
                width: 40%;
            }

            /* Hide non-essential elements if needed or adjust spacing */
            .immediate-history-row .card-header,
            .indirect-comparison-row .card-header {
                padding: 0.25rem 0.5rem;
            }

            .immediate-history-row h5,
            .indirect-comparison-row h5 {
                font-size: 0.75rem;
            }
        }
    </style>
    {% macro render_stat_rows(rows) -%}
    {% for stat in rows %}
    {% set home_txt = stat.home | default('', true) | trim %}
    {% set away_txt = stat.away | default('', true) | trim %}
    {% set home_clean = home_txt | replace(',', '.') %}
    {% set away_clean = away_txt | replace(',', '.') %}
    {% set home_digits = home_clean | replace('.', '') | replace('-', '') | replace('+', '') %}
    {% set away_digits = away_clean | replace('.', '') | replace('-', '') | replace('+', '') %}
    {% set home_is_num = home_digits and home_digits.isdigit() %}
    {% set away_is_num = away_digits and away_digits.isdigit() %}
    {% set home_class = 'home' %}
    {% set away_class = 'away' %}
    {% if home_is_num and away_is_num %}
    {% set home_val = home_clean | float %}
    {% set away_val = away_clean | float %}
    {% if home_val > away_val %}
    {% set home_class = home_class ~ ' text-success' %}
    {% set away_class = away_class ~ ' text-danger' %}
    {% elif away_val > home_val %}
    {% set home_class = home_class ~ ' text-danger' %}
    {% set away_class = away_class ~ ' text-success' %}
    {% endif %}
    {% endif %}
    <tr>
        <td class="{{ home_class }}">{{ stat.home | safe }}</td>
        <td class="label">{{ stat.label }}</td>
        <td class="{{ away_class }}">{{ stat.away | safe }}</td>
    </tr>
    {% endfor %}
    {%- endmacro %}
    {% set odds = data.main_match_odds or {} %}
    <div
        class="panel-header d-flex flex-column flex-md-row align-items-md-center justify-content-md-between gap-3 mb-4">
        <div>
            <h1 class="main-title mb-1">An√°lisis de Partido Avanzado</h1>
            <p class="sub-title mb-0">
                <span class="home-color">{{ data.home_name }}</span>
                <span class="vs-label">vs</span>
                <span class="away-color">{{ data.away_name }}</span>
            </p>
            {% if odds %}
            <div class="panel-odds">
                {% if odds.ah_linea and odds.ah_linea != '-' %}
                <span class="odds-chip">AH {{ odds.ah_linea }}</span>
                {% endif %}
                {% if odds.goals_linea and odds.goals_linea != '-' %}
                <span class="odds-chip">O/U {{ odds.goals_linea }}</span>
                {% endif %}
            </div>
            {% endif %}
        </div>
        <div class="d-flex flex-wrap gap-2">
            {% if odds.ah_linea and odds.ah_linea != '-' %}
            <a href="/explorador?handicap={{ odds.ah_linea }}" class="btn btn-outline-info btn-sm"
                title="Buscar partidos hist√≥ricos con el mismo h√°ndicap">
                <i class="fa-solid fa-globe me-1"></i>Global
            </a>
            <button class="btn btn-outline-info btn-sm pattern-search-trigger" data-handicap="{{ odds.ah_linea }}"
                data-team="{{ data.home_name }}" data-type="team"
                title="Buscar partidos hist√≥ricos de {{ data.home_name }} con este h√°ndicap">
                <i class="fa-solid fa-shirt me-1"></i>{{ data.home_name }}
            </button>
            {% endif %}
            <button class="btn btn-outline-primary btn-sm analysis-preview-trigger"
                data-preview-target="analysis-preview-container" data-match-id="{{ data.match_id or data.id }}">
                <i class="fa-solid fa-eye me-2"></i>Vista previa r√°pida
            </button>
            <button class="btn btn-outline-secondary btn-sm refresh-analysis"
                data-match-id="{{ data.match_id or data.id }}">
                <i class="fa-solid fa-rotate-right me-2"></i>Actualizar datos
            </button>
        </div>
    </div>

    <div id="analysis-preview-container" class="preview-container mb-4" hidden>
        <div class="preview-loading">Buscando an√°lisis detallado...</div>
    </div>

    <div class="accordion" id="analysisAccordion">
        <!-- Clasificaci√≥n y O/U -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne"
                    aria-expanded="true" aria-controls="collapseOne">
                    ‚öΩ Clasificaci√≥n en Liga y Estad√≠sticas O/U
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
                data-bs-parent="#analysisAccordion">
                <div class="accordion-body">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h4 class="card-title text-center home-color">{{ data.home_name }}</h4>
                            {% if data.home_standings and data.home_standings.ranking != 'N/A' %}
                            <p class="text-center"><strong>Posici√≥n:</strong> <span class="data-highlight">{{
                                    data.home_standings.ranking }}</span></p>
                            <h6>Estad√≠sticas Totales</h6>
                            <p><b>PJ:</b> {{ data.home_standings.total_pj }} | <b>V-E-D:</b> {{
                                data.home_standings.total_v }}-{{ data.home_standings.total_e }}-{{
                                data.home_standings.total_d }} | <b>GF:GC:</b> {{ data.home_standings.total_gf }}:{{
                                data.home_standings.total_gc }}</p>
                            <h6>{{ data.home_standings.specific_type }}</h6>
                            <p><b>PJ:</b> {{ data.home_standings.specific_pj }} | <b>V-E-D:</b> {{
                                data.home_standings.specific_v }}-{{ data.home_standings.specific_e }}-{{
                                data.home_standings.specific_d }} | <b>GF:GC:</b> {{ data.home_standings.specific_gf
                                }}:{{ data.home_standings.specific_gc }}</p>
                            {% else %}<p class="text-muted text-center">Datos de clasificaci√≥n no disponibles.</p>{%
                            endif %}
                            <hr>
                            <h6 class="text-center">Over/Under Odds % (√ölt. {{ data.home_ou_stats.total }} partidos)
                            </h6>
                            {% if data.home_ou_stats.total > 0 %}
                            <p class="text-center">
                                <span style="color: green; font-weight: bold;">Over: {{
                                    "%.1f"|format(data.home_ou_stats.over_pct) }}%</span> |
                                <span style="color: red; font-weight: bold;">Under: {{
                                    "%.1f"|format(data.home_ou_stats.under_pct) }}%</span> |
                                <span style="color: grey;">Push: {{ "%.1f"|format(data.home_ou_stats.push_pct)
                                    }}%</span>
                                {% else %}
                            <p class="text-muted text-center">No hay datos O/U.</p>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <h4 class="card-title text-center away-color">{{ data.away_name }}</h4>
                            {% if data.away_standings and data.away_standings.ranking != 'N/A' %}
                            <p class="text-center"><strong>Posici√≥n:</strong> <span class="data-highlight">{{
                                    data.away_standings.ranking }}</span></p>
                            <h6>Estad√≠sticas Totales</h6>
                            <p><b>PJ:</b> {{ data.away_standings.total_pj }} | <b>V-E-D:</b> {{
                                data.away_standings.total_v }}-{{ data.away_standings.total_e }}-{{
                                data.away_standings.total_d }} | <b>GF:GC:</b> {{ data.away_standings.total_gf }}:{{
                                data.away_standings.total_gc }}</p>
                            <h6>{{ data.away_standings.specific_type }}</h6>
                            <p><b>PJ:</b> {{ data.away_standings.specific_pj }} | <b>V-E-D:</b> {{
                                data.away_standings.specific_v }}-{{ data.away_standings.specific_e }}-{{
                                data.away_standings.specific_d }} | <b>GF:GC:</b> {{ data.away_standings.specific_gf
                                }}:{{ data.away_standings.specific_gc }}</p>
                            {% else %}<p class="text-muted text-center">Datos de clasificaci√≥n no disponibles.</p>{%
                            endif %}
                            <hr>
                            <h6 class="text-center">Over/Under Odds % (√ölt. {{ data.away_ou_stats.total }} partidos)
                            </h6>
                            {% if data.away_ou_stats.total > 0 %}
                            <p class="text-center">
                                <span style="color: green; font-weight: bold;">Over: {{
                                    "%.1f"|format(data.away_ou_stats.over_pct) }}%</span> |
                                <span style="color: red; font-weight: bold;">Under: {{
                                    "%.1f"|format(data.away_ou_stats.under_pct) }}%</span> |
                                <span style="color: grey;">Push: {{ "%.1f"|format(data.away_ou_stats.push_pct)
                                    }}%</span>
                                {% else %}
                            <p class="text-muted text-center">No hay datos O/U.</p>{% endif %}
                        </div>
                    </div>
                    <!-- Bet365 Initial Odds Section -->
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card bg-light border-0">
                                <div class="card-body py-2 text-center">
                                    <h6 class="card-subtitle mb-2 text-muted">Cuotas Iniciales (Bet365)</h6>
                                    <div class="d-flex justify-content-center gap-4">
                                        <span class="badge bg-white text-dark border">AH: {{
                                            data.main_match_odds.ah_linea }}</span>
                                        <span class="badge bg-white text-dark border">O/U: {{
                                            data.main_match_odds.goals_linea }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Backtesting Section (Global Pattern) -->
                    {% if data.backtest_global and data.backtest_global.validez %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white py-1">
                                    <h6 class="mb-0 text-center">üéØ Simulaci√≥n Global (Patr√≥n AH {{
                                        data.main_match_odds.ah_linea }} + O/U {{ data.main_match_odds.goals_linea }})
                                    </h6>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row justify-content-center">
                                        <div class="col-md-8 text-center">
                                            <p class="mb-2">
                                                <strong>Probabilidad AH (Local):</strong>
                                                <span
                                                    class="{% if data.backtest_global.prob_ah > 50 %}text-success{% else %}text-danger{% endif %} fw-bold fs-5">
                                                    {{ "%.1f"|format(data.backtest_global.prob_ah) }}%
                                                </span>
                                            </p>
                                            <p class="mb-2">
                                                <strong>Probabilidad O/U {{ data.main_match_odds.goals_linea
                                                    }}:</strong>
                                                <span class="text-success fw-bold">Over: {{
                                                    "%.1f"|format(data.backtest_global.prob_over) }}%</span> |
                                                <span class="text-danger fw-bold">Under: {{
                                                    "%.1f"|format(data.backtest_global.prob_under) }}%</span>
                                            </p>
                                            <p class="text-muted small mb-1">
                                                Basado en <strong>{{ data.backtest_global.stats.total_muestras
                                                    }}</strong> partidos hist√≥ricos con el mismo h√°ndicap inicial.
                                            </p>
                                            {% if data.backtest_global.stats.match_ids %}
                                            <div class="mt-2">
                                                <button class="btn btn-outline-secondary btn-sm py-0 px-2" type="button"
                                                    data-bs-toggle="collapse" data-bs-target="#collapseIds"
                                                    aria-expanded="false" aria-controls="collapseIds"
                                                    style="font-size: 0.7rem;">
                                                    Ver IDs de Patrones
                                                </button>
                                                <div class="collapse mt-1" id="collapseIds">
                                                    <div class="card card-body p-1 bg-light text-muted"
                                                        style="font-size: 0.65rem; max-height: 100px; overflow-y: auto;">
                                                        {{ data.backtest_global.stats.match_ids | join(', ') }}
                                                    </div>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% elif data.backtest_global and not data.backtest_global.validez %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-light text-center py-1 mb-0 small text-muted border">
                                {{ data.backtest_global.mensaje }}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- An√°lisis de Mercado -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSix">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseSix" aria-expanded="true" aria-controls="collapseSix">
                                üìä An√°lisis de Mercado vs. Hist√≥rico H2H
                            </button>
                        </h2>
                        <div id="collapseSix" class="accordion-collapse collapse show" aria-labelledby="headingSix"
                            data-bs-parent="#analysisAccordion">
                            <div class="accordion-body">
                                {% if data.market_analysis_html %}
                                <div class="market-analysis-wrapper">
                                    {{ data.market_analysis_html | safe }}
                                </div>
                                {% else %}
                                <p class="text-muted mb-0">A√∫n no se gener√≥ el an√°lisis de mercado para este partido.
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <h5 class="mb-3 text-muted">Historial inmediato</h5>
                    <div class="row immediate-history-row">
                        <div class="col-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title">√öltimo <span class="home-color">{{ data.home_name }}</span>
                                        (Local)</h5>
                                </div>
                                <div class="card-body">
                                    {% if data.last_home_match %}
                                    {% set res = data.last_home_match %}
                                    <p>
                                        <span class="home-color">{{ res.home_team }}</span>
                                        {% if res.home_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.home_red }}</span>{% endif %}
                                        <span class="score-value mx-1">{{ res.score }}</span>
                                        <span class="away-color">{{ res.away_team }}</span>
                                        {% if res.away_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.away_red }}</span>{% endif %}
                                    </p>
                                    <p class="text-muted small mb-1">{{ res.date }}</p>
                                    <p><b>AH:</b> <span class="ah-value">{{ format_ah(res.handicap_line_raw,
                                            absolute=False) }}</span>
                                    </p>
                                    {% if data.last_home_match.stats_rows %}
                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">Estad√≠sticas</h6>
                                    <table class="stat-table">
                                        {{ render_stat_rows(data.last_home_match.stats_rows) }}
                                    </table>
                                    {% endif %}
                                    {% else %}<p class="text-muted">No se encontr√≥ √∫ltimo partido en casa.</p>{% endif
                                    %}
                                </div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title">√öltimo <span class="away-color">{{ data.away_name }}</span>
                                        (Fuera)</h5>
                                </div>
                                <div class="card-body">
                                    {% if data.last_away_match %}
                                    {% set res = data.last_away_match %}
                                    <p>
                                        <span class="home-color">{{ res.home_team }}</span>
                                        {% if res.home_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.home_red }}</span>{% endif %}
                                        <span class="score-value mx-1">{{ res.score }}</span>
                                        <span class="away-color">{{ res.away_team }}</span>
                                        {% if res.away_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.away_red }}</span>{% endif %}
                                    </p>
                                    <p class="text-muted small mb-1">{{ res.date }}</p>
                                    <p><b>AH:</b> <span class="ah-value">{{ format_ah(res.handicap_line_raw,
                                            absolute=False) }}</span>
                                    </p>
                                    {% if data.last_away_match.stats_rows %}
                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">Estad√≠sticas</h6>
                                    <table class="stat-table">
                                        {{ render_stat_rows(data.last_away_match.stats_rows) }}
                                    </table>
                                    {% endif %}
                                    {% else %}<p class="text-muted">No se encontr√≥ √∫ltimo partido fuera.</p>{% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title">üß≠ H2H Rivales (Col3)</h5>
                                </div>
                                <div class="card-body">
                                    {% if data.h2h_col3 and data.h2h_col3.status == 'found' %}
                                    {% set res = data.h2h_col3 %}
                                    <p>
                                        <span class="home-color">{{ res.h2h_home_team_name }}</span>
                                        {% if res.home_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.home_red }}</span>{% endif %}
                                        <span class="score-value mx-1">{{ res.goles_home }}:{{ res.goles_away }}</span>
                                        <span class="away-color">{{ res.h2h_away_team_name }}</span>
                                        {% if res.away_red %}<span class="badge bg-danger text-white ms-1"
                                            style="font-size: 0.6em;">{{ res.away_red }}</span>{% endif %}
                                    </p>
                                    <p class="text-muted small mb-1">{{ res.date }}</p>
                                    <p><b>AH:</b> <span class="ah-value">{{ format_ah(res.handicap, absolute=False)
                                            }}</span></p>
                                    {% if data.h2h_col3.stats_rows %}
                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">Estad√≠sticas</h6>
                                    <table class="stat-table">
                                        {{ render_stat_rows(data.h2h_col3.stats_rows) }}
                                    </table>
                                    {% endif %}
                                    {% else %}<p class="text-muted">{{ (data.h2h_col3 or {}).get('resultado',
                                        'No disponible.') }}</p>{% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <h5 class="mb-3 text-muted">An√°lisis Detallado</h5>
                    <div class="row">
                        <!-- Comparativas Indirectas -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFour">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseFour" aria-expanded="true" aria-controls="collapseFour">
                                    üîÑ Comparativas Indirectas Detalladas
                                </button>
                            </h2>
                            <div id="collapseFour" class="accordion-collapse collapse show"
                                aria-labelledby="headingFour" data-bs-parent="#analysisAccordion">
                                <div class="accordion-body">
                                    <div class="row indirect-comparison-row">
                                        <div class="col-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h5 class="card-subtitle"><span class="home-color">{{
                                                            data.home_name }}</span> vs. √∫lt. rival de <span
                                                            class="away-color">{{ data.away_name }}</span></h5>
                                                </div>
                                                <div class="card-body">
                                                    {% if data.comparativas_indirectas.left %}
                                                    {% set res = data.comparativas_indirectas.left %}
                                                    <p>üìä <b>Res:</b> <span class="data-highlight">{{ res.score
                                                            }}</span> ({{ res.home_team }} vs {{ res.away_team }})
                                                    </p>
                                                    <p>‚öñÔ∏è <b>AH:</b> <span class="ah-value">{{
                                                            format_ah(res.ah_line, absolute=False) }}</span></p>
                                                    <p>üèüÔ∏è <b>Local√≠a de '{{ data.home_name }}':</b> <span
                                                            class="data-highlight">{{ res.localia }}</span></p>
                                                    {% if data.comparativas_indirectas.left.stats_rows %}
                                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">
                                                        Estad√≠sticas</h6>
                                                    <table class="stat-table">
                                                        {{
                                                        render_stat_rows(data.comparativas_indirectas.left.stats_rows)
                                                        }}
                                                    </table>
                                                    {% endif %}
                                                    {% else %}<p class="text-muted">Comparativa no disponible.</p>{%
                                                    endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h5 class="card-subtitle"><span class="away-color">{{
                                                            data.away_name }}</span> vs. √∫lt. rival de <span
                                                            class="home-color">{{ data.home_name }}</span></h5>
                                                </div>
                                                <div class="card-body">
                                                    {% if data.comparativas_indirectas.right %}
                                                    {% set res = data.comparativas_indirectas.right %}
                                                    <p>üìä <b>Res:</b> <span class="data-highlight">{{ res.score
                                                            }}</span> ({{ res.home_team }} vs {{ res.away_team }})
                                                    </p>
                                                    <p>‚öñÔ∏è <b>AH:</b> <span class="ah-value">{{
                                                            format_ah(res.ah_line, absolute=False) }}</span></p>
                                                    <p>üèüÔ∏è <b>Local√≠a de '{{ data.away_name }}':</b> <span
                                                            class="data-highlight">{{ res.localia }}</span></p>
                                                    {% if data.comparativas_indirectas.right.stats_rows %}
                                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">
                                                        Estad√≠sticas</h6>
                                                    <table class="stat-table">
                                                        {{
                                                        render_stat_rows(data.comparativas_indirectas.right.stats_rows)
                                                        }}
                                                    </table>
                                                    {% endif %}
                                                    {% else %}<p class="text-muted">Comparativa no disponible.</p>{%
                                                    endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- H2H Directo -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingFive">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseFive" aria-expanded="true" aria-controls="collapseFive">
                                    ‚öîÔ∏è Enfrentamientos Directos (H2H)
                                </button>
                            </h2>
                            <div id="collapseFive" class="accordion-collapse collapse show"
                                aria-labelledby="headingFive" data-bs-parent="#analysisAccordion">
                                <div class="accordion-body">
                                    <div class="row indirect-comparison-row">
                                        <div class="col-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h5 class="card-subtitle"><span class="home-color">{{ data.home_name
                                                            }}</span> vs <span class="away-color">{{ data.away_name
                                                            }}</span> (En este estadio)</h5>
                                                </div>
                                                <div class="card-body">
                                                    {% if data.h2h_stadium.res1 != '?:?' %}
                                                    {% set res = data.h2h_stadium %}
                                                    <p>üìä <b>Res:</b> <span class="data-highlight">{{ res.res1 }}</span>
                                                        {% if res.home_red %}<span
                                                            class="badge bg-danger text-white ms-1"
                                                            style="font-size: 0.6em;">{{ res.home_red }}</span>{% endif
                                                        %}
                                                        {% if res.away_red %}<span
                                                            class="badge bg-danger text-white ms-1"
                                                            style="font-size: 0.6em;">{{ res.away_red }}</span>{% endif
                                                        %}
                                                    </p>
                                                    <p class="text-muted small mb-1">{{ res.date }}</p>
                                                    <p>‚öñÔ∏è <b>AH:</b> <span class="ah-value">{{ res.ah1 }}</span></p>
                                                    {% if data.h2h_stadium.stats_rows %}
                                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">Estad√≠sticas
                                                    </h6>
                                                    <table class="stat-table">
                                                        {{ render_stat_rows(data.h2h_stadium.stats_rows) }}
                                                    </table>
                                                    {% endif %}
                                                    {% else %}<p class="text-muted text-center">No se encontr√≥ H2H
                                                        con {{ data.home_name }} en casa.</p>{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="card h-100">
                                                <div class="card-header">
                                                    <h5 class="card-subtitle"><span class="home-color">{{ data.home_name
                                                            }}</span> vs <span class="away-color">{{ data.away_name
                                                            }}</span> (General)</h5>
                                                </div>
                                                <div class="card-body">
                                                    {% if data.h2h_general.res6 != '?:?' %}
                                                    {% set res = data.h2h_general %}
                                                    <p>üìä <b>Res:</b> <span class="data-highlight">{{ res.res6 }}</span>
                                                        ({{ res.h2h_gen_home }} vs {{ res.h2h_gen_away }})
                                                        {% if res.home_red %}<span
                                                            class="badge bg-danger text-white ms-1"
                                                            style="font-size: 0.6em;">{{ res.home_red }}</span>{% endif
                                                        %}
                                                        {% if res.away_red %}<span
                                                            class="badge bg-danger text-white ms-1"
                                                            style="font-size: 0.6em;">{{ res.away_red }}</span>{% endif
                                                        %}
                                                    </p>
                                                    <p class="text-muted small mb-1">{{ res.date }}</p>
                                                    <p>‚öñÔ∏è <b>AH:</b> <span class="ah-value">{{ res.ah6 }}</span></p>
                                                    {% if data.h2h_general.stats_rows %}
                                                    <h6 class="mt-3 text-muted" style="font-size: 0.8em;">Estad√≠sticas
                                                    </h6>
                                                    <table class="stat-table">
                                                        {{ render_stat_rows(data.h2h_general.stats_rows) }}
                                                    </table>
                                                    {% endif %}
                                                    {% else %}<p class="text-muted text-center">No se encontr√≥ H2H
                                                        general.</p>{% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                        <!-- Historial de Partidos (Siempre visible) -->
                        <div class="mt-4">
                            <h5 class="mb-3 text-muted">üìÖ Historial de Partidos (Casa vs Fuera)</h5>
                            <div class="historical-matches-container">
                                {% if data.historical_matches_html %}
                                {{ data.historical_matches_html | safe }}
                                {% else %}
                                <p class="text-muted mb-0">No hay datos hist√≥ricos disponibles.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>