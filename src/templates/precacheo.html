<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Cacheo ⚽</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f7f9fc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .sidebar {
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            width: 250px;
            background-color: #fff;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            z-index: 1000;
        }

        .main-content {
            margin-left: 250px;
            padding: 20px;
        }

        .nav-link {
            color: #333;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .nav-link:hover,
        .nav-link.active {
            background-color: #e9ecef;
            color: #0d6efd;
        }

        .nav-link i {
            width: 25px;
        }

        /* Excel-like Table Styles */
        .excel-table {
            background: #fff;
            border: 1px solid #dee2e6;
            font-size: 0.85rem;
            width: 100%;
        }

        .excel-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 8px;
            vertical-align: middle;
            font-weight: 600;
            color: #495057;
            text-align: center;
        }

        .excel-table td {
            padding: 6px 8px;
            vertical-align: middle;
            border: 1px solid #dee2e6;
        }

        .excel-table tbody tr:hover {
            background-color: #e8f0fe;
        }

        /* Filter Inputs in Header */
        .header-filter {
            width: 100%;
            padding: 4px;
            font-size: 0.8rem;
            border: 1px solid #ced4da;
            border-radius: 3px;
            margin-top: 5px;
        }

        /* Specific Column Styles */
        .col-ah {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
            background-color: #e8f5e9;
        }

        .col-res {
            width: 80px;
            text-align: center;
            font-weight: 800;
            font-size: 1rem;
        }

        .col-team {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .col-prev {
            font-size: 0.85rem;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .status-pending {
            color: #ffc107;
            font-weight: 600;
        }

        .status-scraped {
            color: #17a2b8;
            font-weight: 600;
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <h4 class="mb-4 text-primary"><i class="fa-solid fa-futbol me-2"></i>Analizador</h4>
        <nav class="nav flex-column">
            <a class="nav-link" href="/estudio"><i class="fa-solid fa-chart-line"></i> Estudio</a>
            <a class="nav-link" href="/explorador"><i class="fa-solid fa-compass"></i> Explorador</a>
            <a class="nav-link active" href="/precacheo"><i class="fa-solid fa-clock"></i> Pre-Cacheo</a>
            <a class="nav-link" href="/todos_resultados"><i class="fa-solid fa-list"></i> Resultados</a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center gap-3">
                <h4 class="mb-0"><i class="fa-solid fa-clock me-2"></i>Pre-Cacheo</h4>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary btn-sm active" id="btn-proximos"
                        onclick="setViewMode('proximos')">
                        <i class="fa-solid fa-hourglass-start me-1"></i> Próximos
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm" id="btn-pendientes"
                        onclick="setViewMode('pendientes')">
                        <i class="fa-solid fa-exclamation-triangle me-1"></i> Resultados Pendientes
                    </button>
                </div>
                <span class="badge bg-info" id="current-time-badge">Hora España: --:--</span>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div id="scraping-status" class="d-none"></div>
                <button class="btn btn-success btn-sm" onclick="scrapeAllPending()">
                    <i class="fa-solid fa-download me-1"></i> Scrapear Pendientes
                </button>
                <button class="btn btn-warning btn-sm" onclick="finalizeAllWithResults()">
                    <i class="fa-solid fa-check-double me-1"></i> Finalizar Todos
                </button>
                <button class="btn btn-primary btn-sm" onclick="triggerSearch()">
                    <i class="fa-solid fa-filter me-1"></i> Aplicar Filtros
                </button>
            </div>
        </div>

        <!-- Top Pagination Controls -->
        <nav aria-label="Page navigation" id="pagination-nav-top" class="d-none mb-2">
            <ul class="pagination pagination-sm justify-content-end mb-0" id="pagination-lista-top">
                <!-- Javascript populates this -->
            </ul>
        </nav>

        <div class="table-responsive">
            <table class="table table-bordered table-sm excel-table" id="results-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Fecha</th>
                        <th>Local</th>
                        <th>Visitante</th>
                        <th style="width: 80px;">
                            HA
                            <select class="header-filter" id="filter-handicap">
                                <option value="">Todos</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="2.5">2.5</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                                <option value="-2.5">-2.5</option>
                            </select>
                        </th>
                        <th style="width: 80px;">FT</th>
                        <th>
                            Prev Home
                            <select class="header-filter mt-1" id="filter-prev-home-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-home-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th>
                            Prev Away
                            <select class="header-filter mt-1" id="filter-prev-away-ah" style="width: 100%;">
                                <option value="">AH</option>
                                <option value="0.0">0.0</option>
                                <option value="0.5">0.5</option>
                                <option value="1.0">1.0</option>
                                <option value="1.5">1.5</option>
                                <option value="2.0">2.0</option>
                                <option value="-0.5">-0.5</option>
                                <option value="-1.0">-1.0</option>
                                <option value="-1.5">-1.5</option>
                                <option value="-2.0">-2.0</option>
                            </select>
                            <select class="header-filter mt-1" id="filter-prev-away-res" style="width: 100%;">
                                <option value="">Res...</option>
                                <option value="HOME_WIN">Win</option>
                                <option value="DRAW">Draw</option>
                                <option value="AWAY_WIN">Loss</option>
                            </select>
                        </th>
                        <th style="width: 100px;">H2H Estadio</th>
                        <th style="width: 100px;">H2H General</th>
                        <th>H2H Col3</th>
                        <th>Ind. Local</th>
                        <th>Ind. Visitante</th>
                        <th style="width: 100px;">Acciones</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <nav aria-label="Page navigation" id="pagination-nav" class="d-none mt-3">
            <ul class="pagination justify-content-center" id="pagination-lista">
                <!-- Javascript populates this -->
            </ul>
        </nav>


        <div id="loading-overlay" class="d-none">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status"></div>
                <div id="loading-text" class="mt-2">Cargando...</div>
            </div>
        </div>
    </div>

    <script>
        let upcomingMatches = [];
        let precacheoData = {};
        let currentViewMode = 'proximos'; // 'proximos' o 'pendientes'

        // Pagination State
        let currentPage = 1;
        const itemsPerPage = 300; // User requested limit 300 (approx 200-300)
        let totalFilteredMatches = [];


        function showLoading(show, text = 'Cargando...') {
            document.getElementById('loading-overlay').classList.toggle('d-none', !show);
            document.getElementById('loading-text').textContent = text;
        }

        // Obtener hora actual de España
        function getSpainTime() {
            const now = new Date();
            // Convertir a hora de España
            const spainTime = new Date(now.toLocaleString('en-US', { timeZone: 'Europe/Madrid' }));
            return spainTime;
        }

        function updateCurrentTimeDisplay() {
            const spainTime = getSpainTime();
            const hours = spainTime.getHours().toString().padStart(2, '0');
            const minutes = spainTime.getMinutes().toString().padStart(2, '0');
            document.getElementById('current-time-badge').textContent = `Hora España: ${hours}:${minutes}`;
        }

        function setViewMode(mode) {
            currentViewMode = mode;

            // Actualizar botones
            document.getElementById('btn-proximos').classList.toggle('active', mode === 'proximos');
            document.getElementById('btn-pendientes').classList.toggle('active', mode === 'pendientes');

            // Recargar tabla
            triggerSearch();
        }

        // Parsear hora del partido (formato HH:MM)
        function parseMatchTime(timeStr) {
            if (!timeStr) return null;

            // El formato típico es "HH:MM" como "05:10", "06:00", etc.
            const match = timeStr.match(/(\d{1,2}):(\d{2})/);
            if (!match) return null;

            return {
                hours: parseInt(match[1]),
                minutes: parseInt(match[2])
            };
        }

        // Comparar si el partido es futuro respecto a la hora actual de España
        function isMatchUpcoming(match) {
            const spainTime = getSpainTime();

            // Prefer using full ISO start_time if available
            if (match.start_time) {
                const startTime = new Date(match.start_time);
                return startTime > spainTime;
            }

            // Fallback to simple time comparison (only works for same-day assumptions)
            // This was the buggy legacy behavior, but we keep it just in case
            const matchTimeStr = match.time;
            const matchTime = parseMatchTime(matchTimeStr);
            if (!matchTime) return true;

            const currentMinutes = spainTime.getHours() * 60 + spainTime.getMinutes();
            const matchMinutes = matchTime.hours * 60 + matchTime.minutes;

            return matchMinutes > currentMinutes;
        }

        // Comparar si el partido ya pasó (es candidato a resultado pendiente)
        function isMatchPast(match) {
            return !isMatchUpcoming(match);
        }

        async function triggerSearch() {
            const loadingText = currentViewMode === 'proximos'
                ? 'Cargando partidos próximos...'
                : 'Cargando resultados pendientes...';
            showLoading(true, loadingText);

            try {
                // Load upcoming matches from main page
                const res = await fetch('/api/matches?limit=1000');
                const data = await res.json();
                upcomingMatches = data.matches || [];

                // Load precacheo data
                const precRes = await fetch('/api/precacheo_list');
                const precData = await precRes.json();
                precacheoData = {};
                (precData.matches || []).forEach(m => {
                    precacheoData[m.match_id] = m;
                });

                // Filtrar por modo de vista PRIMERO
                let matchesToShow = upcomingMatches;

                if (currentViewMode === 'proximos') {
                    // Solo partidos con hora > hora actual España
                    matchesToShow = upcomingMatches.filter(m => {
                        return isMatchUpcoming(m);
                    });
                } else if (currentViewMode === 'pendientes') {
                    // Partidos ya pasados SIN resultado final
                    matchesToShow = upcomingMatches.filter(m => {
                        if (!isMatchPast(m)) return false; // Solo los pasados

                        // Verificar si tiene resultado final
                        const pc = precacheoData[m.id];
                        if (!pc) return true; // No scrapeado = pendiente

                        // Si tiene score válido, ya tiene resultado
                        const score = pc.score || pc.final_score || '';
                        if (score && score !== '??' && score !== '?:?' && score.includes(':')) {
                            // Verificar que no sea 0:0 con partido en progreso (sin finalizar)
                            return false; // Ya tiene resultado
                        }
                        return true; // Pendiente de resultado
                    });
                }

                // Apply additional filters
                // Apply additional filters
                const filteredMatches = applyFilters(matchesToShow);

                // Store globally for pagination
                totalFilteredMatches = filteredMatches;
                currentPage = 1; // Reset to page 1 on search

                renderTableWithPagination();
            } catch (err) {
                alert('Error: ' + err.message);
            }

            showLoading(false);
        }

        function renderTableWithPagination() {
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageItems = totalFilteredMatches.slice(start, end);

            renderTable(pageItems);
            renderPaginationControls();
        }

        function changePage(page) {
            if (page < 1 || page > Math.ceil(totalFilteredMatches.length / itemsPerPage)) return;
            currentPage = page;
            renderTableWithPagination();
            // Scroll to top of table
            document.querySelector('.table-responsive').scrollTop = 0;
        }

        function renderPaginationControls() {
            const nav = document.getElementById('pagination-nav');
            const lista = document.getElementById('pagination-lista');
            const totalPages = Math.ceil(totalFilteredMatches.length / itemsPerPage);

            if (totalPages <= 1) {
                nav.classList.add('d-none');
                return;
            }

            nav.classList.remove('d-none');
            lista.innerHTML = '';

            // Previous
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Anterior</a>`;
            lista.appendChild(prevLi);

            // Pages
            // Simple logic: Show all if few, or range if many? 
            // Let's show: 1 ... current-1 current current+1 ... last
            // Or just simplified: Prev [Page X of Y] Next

            // "es decir de 200 i si se supera que pueda navegar por paginas"
            // Let's do simple Prev, Current, Next for now to avoid complexity with many pages

            const infoLi = document.createElement('li');
            infoLi.className = 'page-item disabled';
            infoLi.innerHTML = `<span class="page-link">Página ${currentPage} de ${totalPages} (${totalFilteredMatches.length} partidos)</span>`;
            lista.appendChild(infoLi);

            // Next
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Siguiente</a>`;
            lista.appendChild(nextLi);
        }

        function getAsianResultCategory(teamGoals, oppGoals, ahLine) {
            if (teamGoals === null || oppGoals === null || ahLine === null || isNaN(ahLine)) return 'UNKNOWN';

            const diff = teamGoals - oppGoals;
            const line = parseFloat(ahLine);

            // Handle split lines (e.g. 0.25, 0.75) by calculating average result
            let lines = [];
            if (Math.abs(line % 0.5) === 0.25) {
                if (line > 0) {
                    lines = [line - 0.25, line + 0.25];
                } else {
                    lines = [line + 0.25, line - 0.25];
                }
            } else {
                lines = [line];
            }

            let results = [];
            for (let l of lines) {
                const val = diff + l;
                if (val > 0) results.push(1);
                else if (val < 0) results.push(-1);
                else results.push(0);
            }

            const avgRes = results.reduce((a, b) => a + b, 0) / results.length;

            if (avgRes > 0) return 'HOME_WIN'; // Cover
            if (avgRes < 0) return 'AWAY_WIN'; // No Cover
            return 'DRAW'; // Push
        }

        function calculateWDL(scoreStr, ahRaw, isHomePerspective) {
            if (!scoreStr || !ahRaw) return null;
            try {
                // Ensure format H:A
                const parts = scoreStr.replace('-', ':').split(':');
                if (parts.length !== 2) return null;
                const hg = parseInt(parts[0]);
                const ag = parseInt(parts[1]);

                let ah = parseFloat(ahRaw);
                if (isNaN(ah)) return null;

                // Adjust line for perspective
                // If isHomePerspective=True, we use AH as is (Home AH)
                // If isHomePerspective=False (Away Team), we treat them as Away.
                // Note: Standard Asian Result logic:
                // Home: asian_result(hg, ag, ah)
                // Away: asian_result(ag, hg, -ah)

                if (isHomePerspective) {
                    return getAsianResultCategory(hg, ag, ah);
                } else {
                    return getAsianResultCategory(ag, hg, -ah);
                }
            } catch (e) {
                console.error("Error calc WDL", e);
                return null;
            }
        }

        function normalizeBucket(ah) {
            if (ah === null || ah === undefined || ah === '') return null;
            const val = parseFloat(ah);
            if (isNaN(val)) return null;

            // If integer (close to), return integer
            if (Math.abs(val % 1) < 0.01) return val;

            const base = Math.floor(Math.abs(val));
            const sign = val >= 0 ? 1 : -1;
            // .25, .5, .75 -> .5
            return sign * (base + 0.5);
        }

        function applyFilters(matches) {
            // Team filters removed (inputs deleted)
            const teamHome = '';
            const teamAway = '';
            const handicap = document.getElementById('filter-handicap').value;
            const prevHomeAh = document.getElementById('filter-prev-home-ah').value;
            const prevAwayAh = document.getElementById('filter-prev-away-ah').value;

            // New Result Filters
            const prevHomeRes = document.getElementById('filter-prev-home-res').value;
            const prevAwayRes = document.getElementById('filter-prev-away-res').value;

            // Normalize buckets only once if filters exist
            const fBucketPrevHome = prevHomeAh ? normalizeBucket(prevHomeAh) : null;
            const fBucketPrevAway = prevAwayAh ? normalizeBucket(prevAwayAh) : null;

            // Console Debug
            if (prevHomeAh || prevAwayAh) {
                console.log("Filtering Debug:", {
                    prevHomeAh, fBucketPrevHome,
                    prevAwayAh, fBucketPrevAway
                });
            }

            return matches.filter(m => {
                // Team filter
                if (teamHome && !(m.home_team || '').toLowerCase().includes(teamHome)) return false;
                if (teamAway && !(m.away_team || '').toLowerCase().includes(teamAway)) return false;

                // Handicap filter
                if (handicap) {
                    const mAh = parseFloat(m.handicap);
                    const fAh = parseFloat(handicap);
                    if (isNaN(mAh)) return false;

                    const absF = Math.abs(fAh);

                    // Logic for 2.5 bucket (range >= 2.25)
                    if (absF >= 2.49) {
                        if (fAh > 0) {
                            if (mAh < 2.24) return false;
                        } else {
                            if (mAh > -2.24) return false;
                        }
                    }
                    // Logic for 2.0 bucket (strict 2.0)
                    else if (absF >= 1.99 && absF <= 2.01) {
                        if (Math.abs(mAh - fAh) > 0.01) return false;
                    }
                    // Logic for .5 buckets (0.5, 1.5) => fuzzy range +/- 0.25
                    else if (Math.abs(absF % 1 - 0.5) < 0.01) {
                        if (Math.abs(mAh - fAh) > 0.26) return false;
                    }
                    // Default strict match
                    else {
                        if (Math.abs(mAh - fAh) > 0.01) return false;
                    }
                }

                // Prev Home Attributes
                if (prevHomeAh || prevHomeRes) {
                    const pc = precacheoData[m.id];
                    if (!pc || !pc.last_home_match) return false;

                    if (fBucketPrevHome !== null) {
                        const pAh = parseFloat(pc.last_home_match.handicap_line_raw);
                        const pBucket = normalizeBucket(pAh);

                        console.log(`Match ${m.home_team}: PrevHomeRaw=${pc.last_home_match.handicap_line_raw} pAh=${pAh} pBucket=${pBucket} Filter=${fBucketPrevHome}`);

                        if (pBucket === null) return false;

                        if (Math.abs(fBucketPrevHome) >= 2.5) {
                            if (fBucketPrevHome > 0) {
                                if (pBucket < 2.5) return false;
                            } else {
                                if (pBucket > -2.5) return false;
                            }
                        } else {
                            if (pBucket !== fBucketPrevHome) return false;
                        }
                    }

                    if (prevHomeRes) {
                        const wdl = calculateWDL(pc.last_home_match.score, pc.last_home_match.handicap_line_raw, true);
                        if (wdl !== prevHomeRes) return false;
                    }
                }

                // Prev Away Attributes
                if (prevAwayAh || prevAwayRes) {
                    const pc = precacheoData[m.id];
                    if (!pc || !pc.last_away_match) return false;

                    if (fBucketPrevAway !== null) {
                        const pAh = parseFloat(pc.last_away_match.handicap_line_raw);
                        const pBucket = normalizeBucket(pAh);

                        console.log(`Match ${m.away_team}: PrevAwayRaw=${pc.last_away_match.handicap_line_raw} pAh=${pAh} pBucket=${pBucket} Filter=${fBucketPrevAway}`);

                        if (pBucket === null) return false;

                        if (Math.abs(fBucketPrevAway) >= 2.5) {
                            if (fBucketPrevAway > 0) {
                                if (pBucket < 2.5) return false;
                            } else {
                                if (pBucket > -2.5) return false;
                            }
                        } else {
                            if (pBucket !== fBucketPrevAway) return false;
                        }
                    }

                    if (prevAwayRes) {
                        const wdl = calculateWDL(pc.last_away_match.score, pc.last_away_match.handicap_line_raw, false);
                        if (wdl !== prevAwayRes) return false;
                    }
                }

                return true;
            });
        }

        function renderTable(matches) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (!matches || matches.length === 0) {
                tbody.innerHTML = `<tr><td colspan="11" class="text-center py-4">No hay partidos próximos</td></tr>`;
                return;
            }

            const formatAh = (val) => val !== null && val !== undefined ? val : '-';

            matches.forEach(m => {
                const tr = document.createElement('tr');
                const matchId = m.id;
                const home = m.home_team || '-';
                const away = m.away_team || '-';
                const ah = m.handicap || '-';

                // Format Date/Time
                let fechaDisplay = m.time || '-';
                if (m.start_time) {
                    const d = new Date(m.start_time);
                    const now = getSpainTime();

                    const isToday = d.getDate() === now.getDate() &&
                        d.getMonth() === now.getMonth() &&
                        d.getFullYear() === now.getFullYear();

                    const isTomorrow = new Date(now.getTime() + 86400000).getDate() === d.getDate() &&
                        d.getMonth() === new Date(now.getTime() + 86400000).getMonth();

                    const hours = d.getHours().toString().padStart(2, '0');
                    const minutes = d.getMinutes().toString().padStart(2, '0');

                    if (isToday) {
                        fechaDisplay = `${hours}:${minutes}`;
                    } else if (isTomorrow) {
                        fechaDisplay = `Mañana ${hours}:${minutes}`;
                    } else {
                        const day = d.getDate().toString().padStart(2, '0');
                        const month = (d.getMonth() + 1).toString().padStart(2, '0');
                        fechaDisplay = `${day}/${month} ${hours}:${minutes}`;
                    }
                }
                const fecha = fechaDisplay;

                // Check if scraped
                const pc = precacheoData[matchId];
                const isScraped = !!pc;

                // Check if has valid result (can be finalized)
                let hasValidResult = false;
                if (pc) {
                    const score = pc.score || pc.final_score || '';
                    hasValidResult = score && score !== '??' && score !== '?:?' && score.includes(':');
                }

                // FT (Score)
                let ftHtml = '<span class="text-muted">-</span>';
                if (pc && pc.score && pc.score !== '??') {
                    ftHtml = `<span class="fw-bold text-success">${pc.score}</span>`;
                } else if (pc && pc.final_score && pc.final_score !== '??') {
                    ftHtml = `<span class="fw-bold text-success">${pc.final_score}</span>`;
                } else {
                    ftHtml = '<span class="text-muted">?:?</span>';
                }

                // Prev Home
                let prevHomeHtml = '<span class="text-muted">-</span>';
                if (pc && pc.last_home_match && pc.last_home_match.score) {
                    const lhm = pc.last_home_match;
                    const ahVal = formatAh(lhm.handicap_line_raw);

                    // Calc WDL
                    const wdl = calculateWDL(lhm.score, lhm.handicap_line_raw, true);
                    const wdlClass = wdl === 'HOME_WIN' ? 'text-success' : (wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark');
                    // For Home Perspective: HOME_WIN = Green (Won vs AH), AWAY_WIN = Red (Lost vs AH)

                    // Rival Logic: Display the team that is NOT the current home team
                    // Usually lhm is Home Game for 'home', so rival is away_team.
                    let rivalName = lhm.away_team;
                    // Safety check if lhm.away_team IS the home team (e.g. they played away but it's recorded here?)
                    if (lhm.away_team && (lhm.away_team.includes(home) || home.includes(lhm.away_team))) {
                        rivalName = lhm.home_team;
                    }

                    prevHomeHtml = `
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${ahVal}</span>
                                <span class="fw-bold ${wdlClass}">${lhm.score}</span>
                            </div>
                            <div class="text-muted small text-truncate" style="max-width: 100px;" title="${rivalName}">${rivalName || ''}</div>
                        </div>
                    `;
                }

                // Prev Away
                let prevAwayHtml = '<span class="text-muted">-</span>';
                if (pc && pc.last_away_match && pc.last_away_match.score) {
                    const lam = pc.last_away_match;
                    const ahVal = formatAh(lam.handicap_line_raw);

                    // Calc WDL (perspective = false for away team)
                    const wdl = calculateWDL(lam.score, lam.handicap_line_raw, false);
                    // If calculateWDL return 'HOME_WIN', it means the "perspective team" (Away) WON the handicap
                    const wdlClass = wdl === 'HOME_WIN' ? 'text-success' : (wdl === 'AWAY_WIN' ? 'text-danger' : 'text-dark');

                    // Rival Logic: Display the team that is NOT the current away team
                    // Usually lam is Away Game for 'away', so rival is home_team.
                    let rivalName = lam.home_team;
                    if (lam.home_team && (lam.home_team.includes(away) || away.includes(lam.home_team))) {
                        rivalName = lam.away_team;
                    }

                    prevAwayHtml = `
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${ahVal}</span>
                                <span class="fw-bold ${wdlClass}">${lam.score}</span>
                            </div>
                            <div class="text-muted small text-truncate" style="max-width: 100px;" title="${rivalName}">${rivalName || ''}</div>
                        </div>
                    `;
                }

                // H2H Estadio (from market_analysis_data.stadium)
                let h2hStadiumHtml = '<span class="text-muted">-</span>';
                if (pc && pc.market_analysis_data && pc.market_analysis_data.stadium) {
                    const st = pc.market_analysis_data.stadium;
                    const movColor = st.is_covered === true ? 'text-success' : (st.is_covered === false ? 'text-danger' : 'text-dark');
                    h2hStadiumHtml = `
                        <div class="d-flex flex-column">
                            <div class="fw-bold small ${movColor}">${st.movement || '-'}</div>
                            ${st.result ? `<div class="small ${movColor}" style="font-size: 0.7rem;">${st.result}</div>` : ''}
                        </div>
                    `;
                }

                // H2H General (from market_analysis_data.general)
                let h2hGeneralHtml = '<span class="text-muted">-</span>';
                if (pc && pc.market_analysis_data && pc.market_analysis_data.general) {
                    const gen = pc.market_analysis_data.general;
                    const movColor = gen.is_covered === true ? 'text-success' : (gen.is_covered === false ? 'text-danger' : 'text-dark');
                    h2hGeneralHtml = `
                        <div class="d-flex flex-column">
                            <div class="fw-bold small ${movColor}">${gen.movement || '-'}</div>
                            ${gen.result ? `<div class="small ${movColor}" style="font-size: 0.7rem;">${gen.result}</div>` : ''}
                        </div>
                    `;
                }

                // H2H Col3 (from h2h_col3 object)
                let h2hCol3Html = '<span class="text-muted">-</span>';
                if (pc && pc.h2h_col3 && pc.h2h_col3.status === 'found') {
                    const col3 = pc.h2h_col3;
                    const score = (col3.goles_home !== undefined && col3.goles_away !== undefined) ? `${col3.goles_home}:${col3.goles_away}` : '-';
                    h2hCol3Html = `
                        <div class="d-flex flex-column">
                            <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${col3.handicap || '-'}</span>
                                <span class="fw-bold">${score}</span>
                            </div>
                            <div class="small text-muted" style="font-size: 0.75rem;">
                                ${col3.h2h_home_team_name || ''} vs ${col3.h2h_away_team_name || ''}
                            </div>
                        </div>
                    `;
                }

                // Ind. Comparisons
                let indLeftHtml = '<span class="text-muted">NO</span>';
                if (pc && pc.comparativas_indirectas && pc.comparativas_indirectas.left) {
                    const l = pc.comparativas_indirectas.left;
                    const cov = l.cover_status === 'CUBIERTO' ? 'text-success' : (l.cover_status === 'NO CUBIERTO' ? 'text-danger' : 'text-dark');
                    indLeftHtml = `
                        <div class="d-flex flex-column">
                             <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${l.ah_line || l.ah || '-'}</span>
                                <span class="fw-bold ${cov}">${l.score}</span>
                            </div>
                            <div class="small text-muted" style="font-size: 0.75rem;">${l.home_team || ''} vs ${l.away_team || ''}</div>
                            <div class="small text-muted" style="font-size: 0.65rem;">Loc: ${l.localia || '?'}</div>
                        </div>
                    `;
                }

                let indRightHtml = '<span class="text-muted">NO</span>';
                if (pc && pc.comparativas_indirectas && pc.comparativas_indirectas.right) {
                    const r = pc.comparativas_indirectas.right;
                    const cov = r.cover_status === 'CUBIERTO' ? 'text-success' : (r.cover_status === 'NO CUBIERTO' ? 'text-danger' : 'text-dark');
                    indRightHtml = `
                        <div class="d-flex flex-column">
                             <div class="d-flex justify-content-between">
                                <span class="fw-bold small">${r.ah_line || r.ah || '-'}</span>
                                <span class="fw-bold ${cov}">${r.score}</span>
                            </div>
                            <div class="small text-muted" style="font-size: 0.75rem;">${r.home_team || ''} vs ${r.away_team || ''}</div>
                            <div class="small text-muted" style="font-size: 0.65rem;">Loc: ${r.localia || '?'}</div>
                        </div>
                    `;
                }

                tr.innerHTML = `
                    <td class="text-center"><span class="badge bg-secondary">${fecha}</span></td>
                    <td class="col-team text-primary small" style="font-size: 0.8rem;">${home}</td>
                    <td class="col-team text-danger small" style="font-size: 0.8rem;">${away}</td>
                    <td class="col-ah">${formatAh(ah)}</td>
                    <td class="text-center col-res">${ftHtml}</td>
                    <td class="col-prev">${prevHomeHtml}</td>
                    <td class="col-prev">${prevAwayHtml}</td>
                    <td class="col-prev text-center">${h2hStadiumHtml}</td>
                    <td class="col-prev text-center">${h2hGeneralHtml}</td>
                    <td class="col-prev">${h2hCol3Html}</td>
                    <td class="col-prev">${indLeftHtml}</td>
                    <td class="col-prev">${indRightHtml}</td>
                    <td class="text-center">
                        ${!isScraped
                        ? `<button class="btn btn-sm btn-primary" onclick="scrapeMatch('${matchId}')" title="Scrapear">
                                <i class="fas fa-download"></i>
                               </button>`
                        : `<button class="btn btn-sm btn-outline-info" onclick="scrapeMatch('${matchId}')" title="Re-scrapear">
                                <i class="fas fa-sync"></i>
                               </button>`
                    }
                        ${hasValidResult
                        ? `<button class="btn btn-sm btn-success" onclick="finalizeMatch('${matchId}')" title="Finalizar y mover al Explorador">
                                <i class="fas fa-check"></i>
                               </button>`
                        : ''}
                        <a href="/estudio/${matchId}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Ver Estudio">
                            <i class="fas fa-eye"></i>
                        </a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // Background scraping - doesn't block UI
        let scrapingInProgress = false;
        let scrapingQueue = [];
        let scrapingCurrent = 0;
        let scrapingTotal = 0;

        function updateScrapingStatus() {
            const statusDiv = document.getElementById('scraping-status');
            if (scrapingInProgress) {
                statusDiv.innerHTML = `<span class="badge bg-warning text-dark">
                    <i class="fas fa-spinner fa-spin me-1"></i>
                    Scrapeando ${scrapingCurrent}/${scrapingTotal}
                </span>`;
                statusDiv.classList.remove('d-none');
            } else {
                statusDiv.classList.add('d-none');
            }
        }

        function scrapeMatch(matchId) {
            // Fire and forget - don't await, don't block
            fetch('/api/precacheo_scrape', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ match_id: matchId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error scraping:', data.error);
                    } else {
                        // Update just this row's status
                        precacheoData[matchId] = data.match;
                        // Refresh the table
                        const filteredMatches = applyFilters(upcomingMatches);
                        renderTable(filteredMatches);
                    }
                })
                .catch(err => console.error('Error scraping:', err));

            // Immediately change button to show it's being scraped
            const btn = document.querySelector(`button[onclick="scrapeMatch('${matchId}')"]`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }
        }

        async function scrapeAllPending() {
            const handicap = document.getElementById('filter-handicap').value;
            // Note: Pre-Cacheo page filtering logic might not have goal line filter input, 
            // but if it does, we should capture it. 
            // Looking at the view_file, there is no explicit goal line filter INPUT in precacheo list header, 
            // only AH filter. So we pass handicap.

            if (!confirm(`¿Iniciar scrapeo de pendientes en segundo plano con filtro AH=${handicap || 'Todos'}?\nSe usarán multiples hilos y se guardará el progreso.`)) return;

            try {
                const res = await fetch('/api/precacheo_scrape_background', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        handicap: handicap
                    })
                });
                const data = await res.json();

                if (data.status === 'success') {
                    alert(data.message);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                alert('Error de red al iniciar scraping: ' + err.message);
            }
        }

        // Finalizar un partido individual (mover al Explorador)
        async function finalizeMatch(matchId) {
            const btn = document.querySelector(`button[onclick="finalizeMatch('${matchId}')"]`);
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                btn.disabled = true;
            }

            try {
                const res = await fetch(`/api/precacheo_finalize/${matchId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();

                if (data.status === 'success') {
                    // Eliminar de precacheoData local
                    delete precacheoData[matchId];
                    // Refrescar tabla
                    triggerSearch();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo finalizar'));
                    if (btn) {
                        btn.innerHTML = '<i class="fas fa-check"></i>';
                        btn.disabled = false;
                    }
                }
            } catch (err) {
                console.error('Error finalizando:', err);
                alert('Error de red al finalizar: ' + err.message);
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-check"></i>';
                    btn.disabled = false;
                }
            }
        }

        // Finalizar todos los partidos que tienen resultado
        // Finalizar todos los partidos que tienen resultado
        async function finalizeAllWithResults() {
            // Buscar todos los partidos con resultado válido
            const matchesWithResults = [];
            for (const [matchId, pc] of Object.entries(precacheoData)) {
                // Ensure robust check for score
                const score = pc.score || pc.final_score || '';
                if (score && score !== '??' && score !== '?:?' && score.includes(':')) {
                    matchesWithResults.push(matchId);
                }
            }

            if (matchesWithResults.length === 0) {
                alert('No hay partidos con resultado para finalizar.');
                return;
            }

            if (!confirm(`¿Finalizar ${matchesWithResults.length} partidos y moverlos al Explorador?`)) return;

            showLoading(true, `Finalizando ${matchesWithResults.length} partidos...`);

            try {
                // Batch Request
                const res = await fetch('/api/precacheo_finalize_batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ match_ids: matchesWithResults })
                });

                const data = await res.json();

                if (data.error) {
                    alert('Error: ' + data.error);
                } else {
                    const failures = data.failed_count || 0;
                    const success = data.success_count || 0;

                    if (failures > 0) {
                        alert(`Finalizados ${success}. Fallaron ${failures}. Revisa la consola para más detalles.`);
                        console.error("Batch failures:", data.errors);
                    } else {
                        // Success completely
                        // Optional: simpler alert or just refresh
                        // alert(`Proceso completado. ${success} partidos movidos.`);
                    }
                    // Refresh data
                    await triggerSearch();
                }
            } catch (err) {
                alert('Error de red: ' + err.message);
            } finally {
                showLoading(false);
            }
        }

        // Event listeners for filters
        document.querySelectorAll('.header-filter').forEach(input => {
            input.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    triggerSearch();
                }
            });
            input.addEventListener('change', function (e) {
                if (e.target.tagName === 'SELECT') {
                    triggerSearch();
                }
            });
        });

        // Load on page load
        document.addEventListener('DOMContentLoaded', function () {
            updateCurrentTimeDisplay();
            // Actualizar hora cada minuto
            setInterval(updateCurrentTimeDisplay, 60000);
            triggerSearch();
        });
    </script>
</body>

</html>